<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Template</title>
  <link rel="stylesheet" href="style.css">
</head>

<body class="container">
<div id="toast" class="toast"></div>

<!-- PRINTER STATUS -->
<div id="printerStatus"
     class="printer-chip disconnected"
     onclick="togglePrinter()">

  <div class="printer-icon">
    üñ®Ô∏è
    <span class="status-dot"></span>
  </div>

  <div class="printer-text">
    <div class="printer-title">Printer Offline</div>
    <div class="printer-desc">Tap untuk hubungkan</div>
  </div>
</div>



<h2 id="templateName">Template</h2>

<!-- SEARCH -->
<!-- SEARCH -->
<div class="expired-form">
  <div class="input-box">
    <input id="searchExpired" placeholder="Cari expired item...">
  </div>
</div>

<div id="searchResult" class="search-result"></div>

<hr>


<h3 id="templateCount">Item Dalam Template (0)</h3>
<div class="print-all">
  <span onclick="printAll()">üñ®Ô∏è Print Semua</span>
</div>

<div id="list"></div>


<a class="back" href="index.html">‚¨Ö Kembali</a>

<script src="db.js"></script>
<script>
const templateId = Number(new URLSearchParams(location.search).get('id'));

const searchInput = document.getElementById('searchExpired');
const searchResult = document.getElementById('searchResult');
const list = document.getElementById('list');

let allExpired = [];
let templateItems = [];

/* =====================
   DATE & TIME
===================== */
function formatDate(d) {
  return new Date(d).toLocaleDateString('id-ID');
}

function liveTime() {
  return new Date().toLocaleTimeString('id-ID', {
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  });
}

function calcExpired(days, iso) {
  const d = new Date(iso);
  d.setDate(d.getDate() + days);
  return d.toLocaleDateString('id-ID');
}

/* =====================
   LOAD
===================== */
openDB(() => {
  getAll('expired_items', d => allExpired = d || []);
  loadTemplateName();      // ‚¨Ö INI
  loadTemplateItems();
});


function loadTemplateItems() {
  getAll('template_items', templateLinks => {
    getAll('expired_items', expiredItems => {

      templateItems = templateLinks
        .filter(t => t.templateId === templateId)
        .map(t => {
          const exp = expiredItems.find(e => e.id === t.expiredId);
          if (!exp) return null;

          return {
            ...exp,
            templateItemId: t.id
          };
        })
        .filter(Boolean);

      renderTemplateItems(templateItems);
    });
  });
}

function loadTemplateName() {
  getAll('templates', templates => {
    const t = (templates || []).find(x => x.id === templateId);
    if (t) {
      document.getElementById('templateName').textContent = t.name;
    }
  });
}





/* =====================
   SEARCH
===================== */
searchInput.addEventListener('input', () => {
  const q = searchInput.value.trim().toLowerCase();

  if (!q) {
    searchResult.innerHTML = '';
    return;
  }

  const results = allExpired
    .filter(x => x.name.toLowerCase().includes(q))
    .slice(0, 5);

  renderSearchResults(results);
});


/* =====================
   ADD TO TEMPLATE
===================== */
function addToTemplate(expired) {
  addData('template_items', {
    id: Date.now(),
    templateId,
    expiredId: expired.id
  }, () => {
    showToast('Berhasil ditambahkan', 'success');

    searchInput.value = '';        // ‚¨Ö reset input
    searchResult.innerHTML = '';   // ‚¨Ö hapus hasil search

    loadTemplateItems();
  });
}


/* =====================
   PRINT
===================== */
function printTemplateItem(templateItemId) {
  const o = templateItems.find(x => x.templateItemId === templateItemId);
  if (!o) return;

  alert(
`Tomoro Coffee
${o.name}
Opened : ${formatDate(o.openedAt)}
Time : ${liveTime()}
Masa exp : ${o.days} hari
Expired : ${calcExpired(o.days, o.openedAt)}`
  );
}


function printAll() {
  let t = 'PRINT TEMPLATE\n\n';
  templateItems.forEach(o => {
    t += `${o.name}
Opened : ${formatDate(o.openedAt)}
Time : ${liveTime()}
Masa exp : ${o.days} hari
Expired : ${calcExpired(o.days, o.openedAt)}\n\n`;
  });
  alert(t);
}

/* =====================
   RENDER
===================== */
function renderSearchResults(items) {
  searchResult.innerHTML = '';

  if (!items.length) {
    searchResult.innerHTML = '<p class="empty">Tidak ditemukan</p>';
    return;
  }

  items.forEach(item => {
    searchResult.innerHTML += `
      <div class="expired-card clickable"
           onclick='addToTemplate(${JSON.stringify(item)})'>
        <strong>${item.name}</strong>
      </div>
    `;
  });
}

function renderTemplateItems(items) {
  const count = document.getElementById('templateCount');
  count.textContent = `Item Dalam Template (${items.length})`;

  list.innerHTML = '';

  if (!items.length) {
    list.innerHTML = '<p class="empty">Belum ada item</p>';
    return;
  }

  items.forEach(o => {
    list.innerHTML += `
      <div class="expired-card">
        <div class="expired-title">${o.name}</div>

        <div class="expired-meta">
          Opened : ${formatDate(o.openedAt)}<br>
          Time : <span class="live-time"></span><br>
          Masa exp : ${o.days} hari<br>
          Expired : ${calcExpired(o.days, o.openedAt)}
        </div>

        <div class="expired-actions">
          <button onclick="printTemplateItem(${o.templateItemId})">üñ®Ô∏è</button>
          <button onclick="removeFromTemplate(${o.templateItemId})">üóëÔ∏è</button>
        </div>
      </div>
    `;
  });
}


let toastTimer = null;

function showToast(text, type = 'success') {
  const toast = document.getElementById('toast');

  // reset total
  toast.className = 'toast';
  toast.textContent = text;

  // set warna
  if (type === 'error') {
    toast.classList.add('error');
  }

  // force reflow (biar animasi selalu jalan)
  void toast.offsetWidth;

  toast.classList.add('show');

  // clear timer lama
  if (toastTimer) clearTimeout(toastTimer);

  toastTimer = setTimeout(() => {
    toast.classList.remove('show');
  }, 2000);
}


function removeFromTemplate(templateItemId) {
  if (!confirm('Hapus item dari template?')) return;

  deleteData('template_items', templateItemId, () => {
    showToast('Berhasil dihapus', 'error');
    loadTemplateItems();
  });
}


function updateTime() {
  document.querySelectorAll('.live-time')
    .forEach(e => e.textContent = liveTime());
}
setInterval(updateTime, 1000);

// ===== PRINTER STATE =====
const printer = {
  connected: false,
  device: 'CPJKT14D',
  ip: '192.168.50.146',
  port: '9100',
  type: 'Bluetooth'
};

function renderPrinter() {
  const el = document.getElementById('printerStatus');
  if (!el) return;

  const title = el.querySelector('.printer-title');
  const desc  = el.querySelector('.printer-desc');

  if (printer.connected) {
    el.classList.remove('disconnected');
    el.classList.add('connected');
    title.textContent = 'Printer Connected';
    desc.textContent =
      `${printer.device} ‚Ä¢ ${printer.ip}:${printer.port}`;
  } else {
    el.classList.remove('connected');
    el.classList.add('disconnected');
    title.textContent = 'Printer Offline';
    desc.textContent = 'Tap untuk hubungkan';
  }
}

// TAP ANIMATION + SIMULASI CONNECT
function togglePrinter() {
  if (printer.connected) {
    printer.connected = false;
    showToast('Printer terputus', 'error');
  } else {
    printer.connected = true;
    showToast('Printer terhubung', 'success');
  }
  renderPrinter();
}

// INIT
renderPrinter();



</script>

</body>
</html>