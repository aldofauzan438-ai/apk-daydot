<script>
document.addEventListener('DOMContentLoaded', function () {

  const list = document.getElementById('list');
  const itemName = document.getElementById('itemName');
  const duration = document.getElementById('duration');

  /* ================= AMBIL DATA ================= */
  let expired = [];
  try {
    expired = JSON.parse(localStorage.getItem('expired')) || [];
  } catch {
    expired = [];
  }

  if (!Array.isArray(expired)) {
    alert('Data expired rusak. Refresh dashboard.');
    return;
  }

  const params = new URLSearchParams(location.search);
  const pageId = Number(params.get('id'));

  const data = expired.find(e => e.id === pageId);

  if (!data) {
    list.innerHTML = '<p>Data tidak ditemukan</p>';
    return;
  }

  /* ================= UTIL ================= */
  function formatDateShort(dateStr) {
    const [y,m,d] = dateStr.split('-');
    return `${d}-${m}-${y.slice(2)}`;
  }

  function getLiveTime() {
    return new Date().toLocaleTimeString('id-ID', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function calculateExpired(days, openedDate) {
    const d = new Date(openedDate);
    d.setDate(d.getDate() + days);
    return d.toISOString().split('T')[0];
  }

  /* ================= SIMPAN ================= */
  window.saveOrder = function () {
    if (!itemName.value || !duration.value) {
      alert('Lengkapi data');
      return;
    }

    data.orders.push({
      id: Date.now(),
      name: itemName.value.trim(),
      days: Number(duration.value),
      openedDate: new Date().toISOString().split('T')[0]
    });

    localStorage.setItem('expired', JSON.stringify(expired));
    itemName.value = '';
    duration.value = '';
    render();
  };

  /* ================= RENDER ================= */
  function render() {
    list.innerHTML = '';

    if (!data.orders || data.orders.length === 0) {
      list.innerHTML = '<p>Belum ada item</p>';
      return;
    }

    data.orders.forEach(o => {
      const exp = calculateExpired(o.days, o.openedDate);

      list.innerHTML += `
        <div class="order-card">
          <b>Nama Item : ${o.name}</b><br>
          Opened : ${formatDateShort(o.openedDate)}<br>
          Time : <span class="live-time">${getLiveTime()}</span><br>
          Masa exp : ${o.days} hari<br>
          Expired : ${formatDateShort(exp)}

          <div style="margin-top:8px">
            <button onclick="printOne(${o.id})">üñ®Ô∏è</button>
            <button onclick="editOrder(${o.id})">‚úèÔ∏è</button>
            <button onclick="deleteOrder(${o.id})">üóëÔ∏è</button>
          </div>
        </div>
      `;
    });
  }

  /* ================= PRINT SATU ================= */
  window.printOne = function (orderId) {
    const o = data.orders.find(x => x.id === orderId);
    if (!o) return;

    const exp = calculateExpired(o.days, o.openedDate);

    alert(
`Tomoro Coffee
Nama Item : ${o.name}
Opened : ${formatDateShort(o.openedDate)}
Time : ${getLiveTime()}
Masa exp : ${o.days} hari
Expired : ${formatDateShort(exp)}`
    );
  };

  /* ================= EDIT ================= */
  window.editOrder = function (orderId) {
    const o = data.orders.find(x => x.id === orderId);
    if (!o) return;

    const newName = prompt('Edit nama item', o.name);
    if (newName === null) return;

    const newDays = prompt('Edit masa expired (hari)', o.days);
    if (!newDays || isNaN(newDays)) return;

    o.name = newName.trim();
    o.days = Number(newDays);

    localStorage.setItem('expired', JSON.stringify(expired));
    render();
  };

  /* ================= HAPUS ================= */
  window.deleteOrder = function (orderId) {
    if (!confirm('Hapus item ini?')) return;

    data.orders = data.orders.filter(o => o.id !== orderId);
    localStorage.setItem('expired', JSON.stringify(expired));
    render();
  };

  /* ================= PRINT SEMUA ================= */
  window.printAll = function () {
    let text = 'PRINT SEMUA\n\n';
    const now = getLiveTime();

    data.orders.forEach(o => {
      const exp = calculateExpired(o.days, o.openedDate);
      text += `${o.name}
Opened : ${formatDateShort(o.openedDate)}
Time : ${now}
Masa exp : ${o.days} hari
Expired : ${formatDateShort(exp)}\n\n`;
    });

    alert(text);
  };

  /* ================= LIVE TIME ================= */
  setInterval(() => {
    document.querySelectorAll('.live-time')
      .forEach(el => el.textContent = getLiveTime());
  }, 60000);

  render();
});
</script>
