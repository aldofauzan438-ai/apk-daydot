<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Detail Expired Item</title>
  <link rel="stylesheet" href="style.css">
</head>

<body class="container">

<h2>Detail Expired Item</h2>

<!-- ================= FORM INPUT ================= -->
<div class="input-box">
  <input id="itemName" placeholder="Nama Item">
</div>

<div class="input-box">
  <select id="duration">
    <option value="">Pilih Masa Expired</option>
    <option value="1">1 Hari</option>
    <option value="2">2 Hari</option>
    <option value="4">4 Hari</option>
    <option value="7">7 Hari</option>
    <option value="14">14 Hari</option>
    <option value="30">1 Bulan</option>
    <option value="60">2 Bulan</option>
    <option value="90">3 Bulan</option>
    <option value="180">6 Bulan</option>
  </select>
</div>

<button class="primary" onclick="saveOrder()">Simpan</button>

<hr>

<div class="print-all">
  <span onclick="printAll()">üñ®Ô∏è Print Semua</span>
</div>

<h3>Daftar Item</h3>
<div id="list"></div>

<a href="index.html">‚¨Ö Kembali</a>

<!-- ================= DATABASE ================= -->
<script src="db.js"></script>

<!-- ================= SCRIPT ================= -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  const list = document.getElementById('list');
  const itemName = document.getElementById('itemName');
  const duration = document.getElementById('duration');

  const params = new URLSearchParams(location.search);
  const templateId = Number(params.get('id'));

  if (!templateId) {
    list.innerHTML = '<p>ID template tidak valid</p>';
    return;
  }

  /* ================= UTIL ================= */
  function formatDateShort(d) {
    const [y,m,da] = d.split('-');
    return `${da}-${m}-${y.slice(2)}`;
  }

  function getLiveTime() {
    return new Date().toLocaleTimeString('id-ID', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function calcExpired(days, date) {
    const d = new Date(date);
    d.setDate(d.getDate() + days);
    return d.toISOString().split('T')[0];
  }

  /* ================= LOAD DATA ================= */
  openDB(() => {
    getTemplateById(templateId, data => {

      if (!data) {
        list.innerHTML = '<p>Data template tidak ditemukan</p>';
        return;
      }

      if (!data.orders) data.orders = [];

      /* ================= SIMPAN ================= */
      window.saveOrder = function () {
        if (!itemName.value || !duration.value) {
          alert('Lengkapi data');
          return;
        }

        data.orders.push({
          id: Date.now(),
          name: itemName.value.trim(),
          days: Number(duration.value),
          openedDate: new Date().toISOString().split('T')[0]
        });

        saveTemplate(data, render);
        itemName.value = '';
        duration.value = '';
      };

      /* ================= PRINT SEMUA ================= */
      window.printAll = function () {
        let text = 'PRINT SEMUA\n\n';
        data.orders.forEach(o => {
          text += `${o.name}
Opened : ${formatDateShort(o.openedDate)}
Time : ${getLiveTime()}
Masa exp : ${o.days} hari
Expired : ${formatDateShort(calcExpired(o.days, o.openedDate))}\n\n`;
        });
        alert(text);
      };

      /* ================= PRINT SATU ================= */
      window.printOne = function (id) {
        const o = data.orders.find(x => x.id === id);
        if (!o) return;

        alert(
`Tomoro Coffee
${o.name}
Opened : ${formatDateShort(o.openedDate)}
Time : ${getLiveTime()}
Masa exp : ${o.days} hari
Expired : ${formatDateShort(calcExpired(o.days, o.openedDate))}`
        );
      };

      /* ================= EDIT ================= */
      window.editOrder = function (id) {
        const o = data.orders.find(x => x.id === id);
        if (!o) return;

        const newName = prompt('Nama Item', o.name);
        if (newName === null) return;

        const newDays = prompt('Masa Expired (hari)', o.days);
        if (!newDays || isNaN(newDays)) return;

        o.name = newName.trim();
        o.days = Number(newDays);
        saveTemplate(data, render);
      };

      /* ================= HAPUS ================= */
      window.deleteOrder = function (id) {
        if (!confirm('Hapus item ini?')) return;
        data.orders = data.orders.filter(o => o.id !== id);
        saveTemplate(data, render);
      };

      /* ================= RENDER ================= */
      function render() {
        list.innerHTML = '';

        if (data.orders.length === 0) {
          list.innerHTML = '<p>Belum ada item</p>';
          return;
        }

        data.orders.forEach(o => {
          list.innerHTML += `
            <div class="order-card">
              <div class="order-title">${o.name}</div>

              <div class="order-meta">
                Opened : ${formatDateShort(o.openedDate)}<br>
                Time : <span class="live-time">${getLiveTime()}</span><br>
                Masa exp : ${o.days} hari<br>
                Expired : ${formatDateShort(calcExpired(o.days, o.openedDate))}
              </div>

              <div class="order-actions">
                <button onclick="printOne(${o.id})">üñ®Ô∏è</button>
                <button onclick="editOrder(${o.id})">‚úèÔ∏è</button>
                <button onclick="deleteOrder(${o.id})">üóëÔ∏è</button>
              </div>
            </div>
          `;
        });
      }

      /* ================= LIVE TIME ================= */
      setInterval(() => {
        document.querySelectorAll('.live-time')
          .forEach(el => el.textContent = getLiveTime());
      }, 60000);

      render();
    });
  });
});
</script>

</body>
</html>
