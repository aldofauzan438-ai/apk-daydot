<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Detail Expired Item</title>
  <link rel="stylesheet" href="style.css">
</head>

<body class="container">

<h2>Detail Expired Item</h2>

<div class="expired-form">
  <div class="input-box">
    <input id="itemName" placeholder="Nama Item">
  </div>

  <div class="input-box">
    <select id="duration">
      <option value="">Pilih Masa Expired</option>
      <option value="1">1 Hari</option>
      <option value="2">2 Hari</option>
      <option value="4">4 Hari</option>
      <option value="7">7 Hari</option>
      <option value="14">14 Hari</option>
      <option value="30">1 Bulan</option>
      <option value="60">2 Bulan</option>
      <option value="90">3 Bulan</option>
      <option value="180">6 Bulan</option>
    </select>
  </div>

  <button class="primary" onclick="saveItem()">Simpan</button>
</div>

<div class="print-all">
  <span onclick="printAll()">üñ®Ô∏è Print Semua</span>
</div>

<h3>Daftar Item</h3>
<div id="list"></div>

<a class="back" href="index.html">‚¨Ö Kembali</a>

<script src="db.js"></script>
<script>
const parentId = Number(new URLSearchParams(location.search).get('id'));
let expiredData = [];

const list = document.getElementById('list');
const itemName = document.getElementById('itemName');
const duration = document.getElementById('duration');

/* =====================
   DATE & TIME UTIL
===================== */
function formatDate(iso) {
  const d = new Date(iso);
  return d.toLocaleDateString('id-ID');
}

function liveTime() {
  return new Date().toLocaleTimeString('id-ID', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
}

function calcExpiredDate(days, iso) {
  const d = new Date(iso);
  d.setDate(d.getDate() + days);
  return d.toLocaleDateString('id-ID');
}

/* =====================
   DB LOAD
===================== */
openDB(loadData);

function loadData() {
  getAll('expired_items', data => {
    expiredData = (data || []).filter(x => x.parentId === parentId);
    render();
  });
}

/* =====================
   CRUD
===================== */
window.saveItem = function () {
  if (!itemName.value || !duration.value) {
    alert('Lengkapi data');
    return;
  }

  addData('expired_items', {
    id: Date.now(),
    parentId,
    name: itemName.value.trim(),
    days: Number(duration.value),
    openedAt: new Date().toISOString()
  }, loadData);

  itemName.value = '';
  duration.value = '';
};

window.editItem = function (id) {
  const o = expiredData.find(x => x.id === id);
  if (!o) return;

  const n = prompt('Nama Item', o.name);
  if (n === null) return;

  const d = prompt('Masa Expired (hari)', o.days);
  if (!d || isNaN(d)) return;

  o.name = n.trim();
  o.days = Number(d);
  addData('expired_items', o, loadData);
};

window.deleteItem = function (id) {
  if (!confirm('Hapus item ini?')) return;
  deleteData('expired_items', id, loadData);
};

/* =====================
   PRINT
===================== */
window.printOne = function (id) {
  const o = expiredData.find(x => x.id === id);
  if (!o) return;

  alert(
`Tomoro Coffee
${o.name}
Opened  : ${formatDate(o.openedAt)}
Time    : ${liveTime()}
Masa exp: ${o.days} hari
Expired : ${calcExpiredDate(o.days, o.openedAt)}`
  );
};

window.printAll = function () {
  let t = 'PRINT SEMUA\n\n';
  expiredData.forEach(o => {
    t += `${o.name}
Opened  : ${formatDate(o.openedAt)}
Time    : ${liveTime()}
Masa exp: ${o.days} hari
Expired : ${calcExpiredDate(o.days, o.openedAt)}\n\n`;
  });
  alert(t);
};

/* =====================
   RENDER
===================== */
function render() {
  list.innerHTML = '';
  if (expiredData.length === 0) {
    list.innerHTML = '<p class="empty">Belum ada item</p>';
    return;
  }

  expiredData.forEach(o => {
    list.innerHTML += `
      <div class="expired-card">
        <div class="expired-title">
          Nama Item : ${o.name}
        </div>

        <div class="expired-meta">
          Opened : ${formatDate(o.openedAt)}<br>
          Time : <span class="live-time"></span><br>
          Masa exp : ${o.days} hari<br>
          Expired : ${calcExpiredDate(o.days, o.openedAt)}
        </div>

        <div class="expired-actions">
          <button onclick="printOne(${o.id})">üñ®Ô∏è</button>
          <button onclick="editItem(${o.id})">‚úèÔ∏è</button>
          <button onclick="deleteItem(${o.id})">üóëÔ∏è</button>
        </div>
      </div>
    `;
  });

  updateLiveTime();
}

/* =====================
   LIVE CLOCK (DETIK)
===================== */
function updateLiveTime() {
  document.querySelectorAll('.live-time')
    .forEach(el => el.textContent = liveTime());
}

setInterval(updateLiveTime, 1000);
</script>

</body>
</html>